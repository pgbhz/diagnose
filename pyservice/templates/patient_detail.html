{% extends "base.html" %}
{% block content %}
<a class="back-link" href="/">← Back to patients</a>
<h2>Patient: {{ patient_id }}</h2>
<div class="table-wrapper">
    <table>
        <thead>
            <tr>
                <th>Timestamp</th>
                <th>Verdict</th>
                <th>Rationale</th>
                <th>Photo</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% if entries %}
            {% for entry in entries %}
            {% set verdict_class = "positive" if entry.verdict == "Positive" else ("negative" if entry.verdict ==
            "Negative" else "unknown") %}
            <tr>
                <td>{{ entry.timestamp }}</td>
                <td><span class="badge {{ verdict_class }}">{{ entry.verdict }}</span></td>
                <td>{{ entry.rationale or "—" }}</td>
                <td>
                    {% if entry.photo_url %}
                    <a href="{{ entry.photo_url }}" target="_blank">View photo</a>
                    {% elif entry.photo_path %}
                    {{ entry.photo_path }}
                    {% else %}
                    —
                    {% endif %}
                </td>
                <td>
                    {% if entry.photo_path %}
                    <button type="button" class="classify-btn" data-photo-path="{{ entry.photo_path|e }}">
                        Classify Image with MobileNet
                    </button>
                    <div class="classify-result" aria-live="polite"></div>
                    {% else %}
                    —
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            {% else %}
            <tr>
                <td colspan="4">No entries recorded for this patient.</td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>
<script>
document.addEventListener("DOMContentLoaded", () => {
    const buttons = document.querySelectorAll(".classify-btn");
    buttons.forEach((button) => {
        button.addEventListener("click", async () => {
            const photoPath = button.dataset.photoPath;
            const resultElement = button.parentElement.querySelector(".classify-result");
            if (!photoPath || !resultElement) {
                return;
            }
            button.disabled = true;
            resultElement.textContent = "Running inference...";
            try {
                const response = await fetch("/api/classify-image", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({photo_path: photoPath})
                });
                const payload = await response.json().catch(() => null);
                if (!response.ok) {
                    const detail = payload && payload.detail ? payload.detail : response.statusText;
                    throw new Error(detail);
                }
                if (!payload) {
                    throw new Error("Unexpected response from model service");
                }
                const label = payload.label === "c" ? "Cancer" : "Non-Cancer";
                const probability = (payload.probability * 100).toFixed(2);
                resultElement.textContent = `${label} (${probability}%)`;
            } catch (error) {
                resultElement.textContent = `Error: ${error.message}`;
            } finally {
                button.disabled = false;
            }
        });
    });
});
</script>
{% endblock %}